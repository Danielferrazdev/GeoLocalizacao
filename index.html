<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <title>UPA mais pr√≥xima com rota</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        #info {
            padding: 12px;
            background-color: #0077cc;
            color: white;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
        }

        #map {
            height: 80vh;
            width: 100%;
        }

        #reload-btn {
            display: block;
            margin: 10px auto;
            padding: 8px 16px;
            background-color: #0077cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        #reload-btn:hover {
            background-color: #005fa3;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="info">
        <span id="status-text">Buscando sua localiza√ß√£o...</span>
        <span id="loading" class="loading"></span>
    </div>
    <div id="map"></div>
    <button id="reload-btn" style="display: none;">Recarregar Localiza√ß√£o</button>

    <script>
        let map, directionsService, directionsRenderer, placesService;
        let userLocation = null;

        function initMap() {
            // Inicializa o mapa com posi√ß√£o padr√£o (S√£o Paulo)
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: -23.5505, lng: -46.6333 },
                zoom: 14
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map });

            // Tenta obter a localiza√ß√£o do usu√°rio
            getUserLocation();

            // Configura o bot√£o de recarregar
            document.getElementById("reload-btn").addEventListener("click", () => {
                document.getElementById("status-text").textContent = "Buscando sua localiza√ß√£o...";
                document.getElementById("loading").style.display = "inline-block";
                document.getElementById("reload-btn").style.display = "none";
                getUserLocation();
            });
        }

        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        map.setCenter(userLocation);
                        new google.maps.Marker({
                            position: userLocation,
                            map,
                            title: "Voc√™ est√° aqui"
                        });
                        findNearbyUPAs();
                    },
                    (error) => {
                        let errorMessage = "Erro ao obter localiza√ß√£o.";
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "Permiss√£o de localiza√ß√£o negada. Ative-a e recarregue.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "Localiza√ß√£o indispon√≠vel.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "Tempo de busca esgotado. Tente novamente.";
                                break;
                        }
                        updateStatus(errorMessage, false);
                    },
                    { timeout: 10000 } // Timeout de 10 segundos
                );
            } else {
                updateStatus("Seu navegador n√£o suporta geolocaliza√ß√£o.", false);
            }
        }

        function findNearbyUPAs() {
            updateStatus("Procurando UPAs pr√≥ximas...", true);

            placesService = new google.maps.places.PlacesService(map);
            placesService.nearbySearch(
                {
                    location: userLocation,
                    radius: 5000,
                    keyword: "UPA",
                    type: "hospital"
                },
                (results, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                        const nearestUPA = results[0];
                        showUPAInfo(nearestUPA);
                    } else {
                        updateStatus("Nenhuma UPA encontrada nas proximidades.", false);
                    }
                }
            );
        }

        function showUPAInfo(upa) {
            const destino = upa.geometry.location;
            const nome = upa.name;

            new google.maps.Marker({
                position: destino,
                map,
                title: nome
            });

            directionsService.route(
                {
                    origin: userLocation,
                    destination: destino,
                    travelMode: google.maps.TravelMode.DRIVING
                },
                (response, status) => {
                    if (status === "OK") {
                        directionsRenderer.setDirections(response);
                        const tempo = response.routes[0].legs[0].duration.text;
                        updateStatus(`üïí Tempo estimado at√© "${nome}": ${tempo}`, false);
                    } else {
                        updateStatus("Erro ao tra√ßar rota.", false);
                    }
                }
            );
        }

        function updateStatus(message, isLoading) {
            document.getElementById("status-text").textContent = message;
            document.getElementById("loading").style.display = isLoading ? "inline-block" : "none";
            document.getElementById("reload-btn").style.display = isLoading ? "none" : "block";
        }
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBsE4MHqIc8tmMeWYuO44qhoSad4eZ41qw&libraries=places&callback=initMap">
        </script>
</body>

</html>